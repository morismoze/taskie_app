name: API Rollback

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Select Target Environment"
        required: true
        default: "Production"
        type: choice
        options:
          - Production
          # Staging will be added in the future if needed
      image_tag:
        description: 'Docker Tag to rollback to (e.g., sha-5f2a1b3... or specific version). DO NOT use "latest".'
        required: true
        type: string
      confirm_rollback:
        description: 'Type "rollback" to confirm'
        required: true
        default: ""

permissions:
  # Needed for docker pull
  packages: read

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}
    steps:
      # 1. Safety Checks
      - name: Safety Check - Confirmation
        if: inputs.confirm_rollback != 'rollback'
        run: |
          echo "‚ùå You must type 'rollback' to confirm."
          exit 1

      - name: Safety Check - Production Branch Restriction
        # If target is Production, we MUST be on the 'main' branch
        if: inputs.target_env == 'Production' && github.ref != 'refs/heads/main'
        run: |
          echo "‚ùå Production deployment is only allowed from the 'main' branch."
          echo "Current branch: ${{ github.ref }}"
          exit 1

      - name: Safety Check - Tag Validation
        if: inputs.image_tag == 'latest'
        run: |
          echo "‚ùå You cannot rollback to 'latest'. Please provide a specific SHA tag (e.g., sha-e3b1c...)."
          exit 1

      # 2. SSH Rollback
      - name: Rollback on Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Forward GITHUB_TOKEN as a variable so it's not in the logs
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Forward ENV as a variable so it's not in the logs
          ENV_FILE_CONTENT: ${{ secrets.API_ENV }}
        with:
          host: ${{ secrets.API_SSH_HOST }}
          username: ${{ secrets.API_SSH_USER }}
          key: ${{ secrets.API_SSH_KEY }}
          port: 22
          envs: GH_TOKEN,ENV_FILE_CONTENT
          script: |
            # Define Variables
            TARGET_TAG="${{ inputs.image_tag }}"
            REPO_NAME="${{ github.repository }}"
            # Convert to lowercase just in case, as GHCR is case sensitive
            IMAGE_REPO=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]')
            IMAGE_URL="ghcr.io/$IMAGE_REPO:$TARGET_TAG"

            if [ "${{ inputs.target_env }}" == "Production" ]; then
              CONTAINER_NAME="taskie-api"
              echo "üîô Rolling back PRODUCTION to tag: $TARGET_TAG"
            else
              CONTAINER_NAME="taskie-api-staging"
              echo "üîô Rolling back STAGING to tag: $TARGET_TAG"
            fi

            # 1. Login to Registry
            echo $GH_TOKEN | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 2. Validate Image Exists BEFORE stopping current app
            echo "üîç Verifying image exists: $IMAGE_URL"
            if ! docker pull $IMAGE_URL; then
                echo "‚ùå Error: Image tag '$TARGET_TAG' not found in registry!"
                echo "Aborting rollback to prevent downtime."
                exit 1
            fi

            # 3. Create .env (Just to be sure environment matches expectation)
            printf '%s' "$ENV_FILE_CONTENT" > .env

            # 4. Stop and Remove Current Container
            echo "üõë Stopping current container..."
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            # 5. Run Previous Version
            echo "üöÄ Starting rollback version..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              --env-file .env \
              --network host \
              $IMAGE_URL

            # 6. Database Handling Warning
            echo "‚ö†Ô∏è  WARNING: Database schema was NOT rolled back."
            echo "If the new version ran migrations that are incompatible with this old code,"
            echo "you must manually revert migrations using 'npm run db:migration:revert' inside the container."

            # Cleanup - cleans up dangling images to save space
            docker image prune -f

            echo "‚úÖ Rollback successful! App is running on the version $TARGET_TAG"
