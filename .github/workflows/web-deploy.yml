name: Web Deploy

on:
  workflow_dispatch:

jobs:
  deploy-web:
    runs-on: ubuntu-latest
    # At this project phase web deployment is simple landing page
    # and can go directly to production
    environment: production
    steps:
      # 1. Branch Check
      - name: Safety Check - Branch Restriction
        if: github.ref != 'refs/heads/main'
        run: |
          echo "‚ùå Production deployment is only allowed from the 'main' branch."
          echo "Current branch: ${{ github.ref }}"
          exit 1

      # 2. Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3. Minify the code
      # 3a. Setup Node.js env
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3b. Minification (Native Script)
      - name: Build and Minify
        run: |
          # Copy all files (images, fonts, html...) to web_dist
          mkdir -p web_dist
          cp -r web/. web_dist/

          npm install -g html-minifier-terser

          # Find all .html files in web_dist and minify them "in-place"
          find web_dist -type f -name "*.html" -exec html-minifier-terser \
            --collapse-whitespace \
            --remove-comments \
            --minify-css true \
            --minify-js true \
            -o {} {} \;

      # 4. SSH Deploy Web Files to VPS
      - name: Deploy Web files to Server via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.API_SSH_HOST }}
          username: ${{ secrets.API_SSH_USER }}
          key: ${{ secrets.API_SSH_KEY }}
          port: 22
          source: "web_dist/*"
          target: "/tmp/taskie_web_temp"
          # Removes 'web_dist/' prefix so we don't get something like /tmp/taskie_web_temp/web_dist/index.html
          strip_components: 1

      # 5. Move files to final location and set permissions
      - name: Move files and Set Permissions via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.API_SSH_HOST }}
          username: ${{ secrets.API_SSH_USER }}
          key: ${{ secrets.API_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Starting deployment logic..."

            # 1. Create directory if it doesn't exist
            sudo mkdir -p /var/www/taskieapp/public

            # 2. CLEANUP: Remove old files to prevent "ghost" files
            sudo rm -rf /var/www/taskieapp/public/*

            # 3. Copy new files from temp to public directory
            sudo cp -r /tmp/taskie_web_temp/. /var/www/taskieapp/public/

            # 4. Set permissions (CRITICAL for Nginx because Nginx acts on the server under
            # www-data user, and these files are ownsed by the SSH user we used to copy them
            # so we need to change ownership to www-data)
            sudo chown -R www-data:www-data /var/www/taskieapp/public
            sudo chmod -R 755 /var/www/taskieapp/public

            # 5. Cleanup temp directory
            rm -rf /tmp/taskie_web_temp

            echo "‚úÖ Deployment successful!"
